

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <link rel="stylesheet" href="/v0.90/assets/css/just-the-docs-default.css">

  

  
    <script src="/v0.90/assets/js/vendor/lunr.min.js"></script>
  

  

  <script src="/v0.90/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  
    <link rel="icon" href="/v0.90/favicon.ico" type="image/x-icon">
  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Internal database structure | lakeFS</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Internal database structure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Brief introduction to lakeFS over KV" />
<meta property="og:description" content="Brief introduction to lakeFS over KV" />
<meta property="og:site_name" content="lakeFS" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Internal database structure" />
<script type="application/ld+json">
{"description":"Brief introduction to lakeFS over KV","@type":"WebPage","headline":"Internal database structure","url":"/v0.90/understand/how/kv.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/v0.90/assets/logo.svg"}},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Google Tag Manager Head -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KTZBZW9');</script>
<!-- End Google Tag Manager Head -->
<meta property="og:image" content="/v0.90/assets/img/shared-image.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/fontawesome.min.css" integrity="sha512-giQeaPns4lQTBMRpOOHsYnGw1tGVzbAIHUyHRgn7+6FmiEgGGjaG0T2LZJmAPMzRCl+Cug0ItQ2xDZpTmEc+CQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script src="/v0.90/assets/js/copy-code.js"></script>
<script>
    $(function () {
        $(".tabs").tabs();
    });
</script>
<script src="/v0.90/assets/js/feedback.js"></script>


</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KTZBZW9"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-link">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-search">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="16px" viewBox="0 0 20 16" version="1.1"
             class="feather feather-menu">
            <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="header-/-mobile" transform="translate(-30.000000, -32.000000)" fill="#279890">
                    <g id="Group" transform="translate(30.000000, 32.000000)">
                        <path
                                d="M20,14 L20,16 L0,16 L0,14 L20,14 Z M20,7 L20,9 L0,9 L0,7 L20,7 Z M20,0 L20,2 L0,2 L0,0 L20,0 Z"
                                id="mobile-menu" />
                    </g>
                </g>
            </g>
        </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-chevron-right">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-file">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
    </symbol>
</svg>
<div class="body-wrapper">
    <div class="side-bar">
        <div class="site-header">
            <a href="https://lakefs.io" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
            <a href="#" id="menu-button" class="site-button">
                <svg viewBox="0 0 24 24" class="icon">
                    <use xlink:href="#svg-menu"></use>
                </svg>
            </a>
        </div>
        <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
            
            <div class="search">
                <div class="search-input-wrap">
                    <input type="text" id="search-input" class="search-input" tabindex="0"
                           placeholder="Search lakeFS" aria-label="Search lakeFS"
                           autocomplete="off">
                    <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon">
                            <use xlink:href="#svg-search"></use>
                        </svg></label>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
            

            <div class="nav-category nav-version">
                <label for="selectversion">Version:</label>
                <select id="selectversion" name="version" onchange="javascript:location.href = '/' + encodeURI(this.value);">
                    <option value="" selected>Latest</option>
                </select>
            </div>
            <script async>
                window.addEventListener("load",  async () => {
                    const pathFirstLevel = location.pathname.split('/')[1];
                    const selectedVersion = pathFirstLevel.startsWith('v') && pathFirstLevel || '';
                    const selectVersionElmFirst = document.getElementById('selectversion').firstElementChild;
                    const response = await fetch('/versions.json');
                    if (!response.ok) {
                        return
                    }
                    const versions = await response.json();
                    for (let [key, value] of Object.entries(versions)) {
                        const el = document.createElement("option");
                        el.value = key;
                        el.textContent = value;
                        if (key === selectedVersion) {
                            el.selected = true;
                        }
                        selectVersionElmFirst.after(el);
                    }
                });
            </script>

            <ul class="nav-list"><li
            class="nav-list-item"><a href="/v0.90/"
           class="nav-list-link">What is lakeFS</a></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/quickstart/"
           class="nav-list-link">Quickstart</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/quickstart/run.html"
                   class="nav-list-link">Run lakeFS</a></li><li class="nav-list-item "><a href="/v0.90/quickstart/repository.html"
                   class="nav-list-link">Create a Repository</a></li><li class="nav-list-item "><a href="/v0.90/quickstart/add_data.html"
                   class="nav-list-link">Add Data</a></li><li class="nav-list-item "><a href="/v0.90/quickstart/first_commit.html"
                   class="nav-list-link">Commit the Changes</a></li><li class="nav-list-item "><a href="/v0.90/quickstart/more_quickstart_options.html"
                   class="nav-list-link">More Quickstart Options</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/deploy/"
           class="nav-list-link">Deploy and Setup lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/deploy/aws.html"
                   class="nav-list-link">AWS</a></li><li class="nav-list-item "><a href="/v0.90/deploy/azure.html"
                   class="nav-list-link">Azure</a></li><li class="nav-list-item "><a href="/v0.90/deploy/gcp.html"
                   class="nav-list-link">GCP</a></li><li class="nav-list-item "><a href="/v0.90/deploy/onprem.html"
                   class="nav-list-link">On-Prem</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/integrations/"
           class="nav-list-link">Integrations</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/integrations/spark.html"
                   class="nav-list-link">Spark</a></li><li class="nav-list-item "><a href="/v0.90/integrations/delta.html"
                   class="nav-list-link">Delta Lake</a></li><li class="nav-list-item "><a href="/v0.90/integrations/aws_cli.html"
                   class="nav-list-link">AWS CLI</a></li><li class="nav-list-item "><a href="/v0.90/integrations/airflow.html"
                   class="nav-list-link">Airflow</a></li><li class="nav-list-item "><a href="/v0.90/integrations/python.html"
                   class="nav-list-link">Python</a></li><li class="nav-list-item "><a href="/v0.90/integrations/duckdb.html"
                   class="nav-list-link">DuckDB</a></li><li class="nav-list-item "><a href="/v0.90/integrations/glue_hive_metastore.html"
                   class="nav-list-link">Glue / Hive metastore</a></li><li class="nav-list-item "><a href="/v0.90/integrations/presto_trino.html"
                   class="nav-list-link">Presto/Trino</a></li><li class="nav-list-item "><a href="/v0.90/integrations/athena.html"
                   class="nav-list-link">Amazon Athena</a></li><li class="nav-list-item "><a href="/v0.90/integrations/kubeflow.html"
                   class="nav-list-link">Kubeflow</a></li><li class="nav-list-item "><a href="/v0.90/integrations/airbyte.html"
                   class="nav-list-link">Airbyte</a></li><li class="nav-list-item "><a href="/v0.90/integrations/dbt.html"
                   class="nav-list-link">dbt</a></li><li class="nav-list-item "><a href="/v0.90/integrations/kakfa.html"
                   class="nav-list-link">Kafka</a></li><li class="nav-list-item "><a href="/v0.90/integrations/sagemaker.html"
                   class="nav-list-link">SageMaker</a></li><li class="nav-list-item "><a href="/v0.90/integrations/hive.html"
                   class="nav-list-link">Hive</a></li><li class="nav-list-item "><a href="/v0.90/integrations/dremio.html"
                   class="nav-list-link">Dremio</a></li><li class="nav-list-item "><a href="/v0.90/integrations/iceberg.html"
                   class="nav-list-link">Iceberg</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/hooks/"
           class="nav-list-link">Hooks</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/hooks/overview.html"
                   class="nav-list-link">Overview</a></li><li class="nav-list-item "><a href="/v0.90/hooks/lua.html"
                   class="nav-list-link">Lua</a></li><li class="nav-list-item "><a href="/v0.90/hooks/webhooks.html"
                   class="nav-list-link">Webhooks</a></li><li class="nav-list-item "><a href="/v0.90/hooks/airflow.html"
                   class="nav-list-link">Airflow</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/use_cases/"
           class="nav-list-link">Use Cases</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/use_cases/etl_testing.html"
                   class="nav-list-link">ETL Testing Environment</a></li><li class="nav-list-item "><a href="/v0.90/use_cases/rollback.html"
                   class="nav-list-link">Rollback</a></li><li class="nav-list-item "><a href="/v0.90/use_cases/reproducibility.html"
                   class="nav-list-link">Reproducibility</a></li><li class="nav-list-item "><a href="/v0.90/use_cases/cicd_for_data.html"
                   class="nav-list-link">CI/CD for data lakes</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/howto/"
           class="nav-list-link">How-To</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/howto/import.html"
                   class="nav-list-link">Import data into lakeFS</a></li><li class="nav-list-item "><a href="/v0.90/howto/garbage-collection.html"
                   class="nav-list-link">Garbage Collection</a></li><li class="nav-list-item "><a href="/v0.90/howto/upgrade.html"
                   class="nav-list-link">Upgrade lakeFS</a></li><li class="nav-list-item "><a href="/v0.90/howto/export.html"
                   class="nav-list-link">Exporting Data</a></li><li class="nav-list-item "><a href="/v0.90/howto/copying.html"
                   class="nav-list-link">Copying data to/from lakeFS</a></li><li class="nav-list-item "><a href="/v0.90/howto/protect-branches.html"
                   class="nav-list-link">Protect Branches</a></li><li class="nav-list-item "><a href="/v0.90/howto/migrate-away.html"
                   class="nav-list-link">Migrating away from lakeFS</a></li><li class="nav-list-item "><a href="/v0.90/howto/sizing-guide.html"
                   class="nav-list-link">Sizing Guide</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/reference/"
           class="nav-list-link">Reference</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/reference/configuration.html"
                   class="nav-list-link">Configuration</a></li><li class="nav-list-item "><a href="/v0.90/reference/cli.html"
                   class="nav-list-link">CLI (lakectl)</a></li><li class="nav-list-item "><a href="/v0.90/reference/api.html"
                   class="nav-list-link">API Reference</a></li><li class="nav-list-item "><a href="/v0.90/reference/spark-client.html"
                   class="nav-list-link">Spark Client</a></li><li class="nav-list-item "><a href="/v0.90/reference/s3.html"
                   class="nav-list-link">S3 Supported API</a></li><li class="nav-list-item "><a href="/v0.90/reference/authentication.html"
                   class="nav-list-link">Authentication</a></li><li class="nav-list-item "><a href="/v0.90/reference/saml-authentication-integration.html"
                   class="nav-list-link">SAML Authentication Integration</a></li><li class="nav-list-item "><a href="/v0.90/reference/authorization.html"
                   class="nav-list-link">Authorization</a></li><li class="nav-list-item "><a href="/v0.90/reference/monitor.html"
                   class="nav-list-link">Monitoring using Prometheus</a></li></ul></li><li
            class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.90/understand/"
           class="nav-list-link">Understanding lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.90/understand/architecture.html"
                   class="nav-list-link">Architecture</a></li><li class="nav-list-item "><a href="/v0.90/understand/model.html"
                   class="nav-list-link">Model</a></li><li class="nav-list-item "><a href="/v0.90/understand/performance-best-practices.html"
                   class="nav-list-link">Performance Best Practices</a></li><li class="nav-list-item  active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                        <use xlink:href="#svg-arrow-right"></use>
                    </svg></a><a href="/v0.90/understand/how/"
                   class="nav-list-link">How it Works</a><ul class="nav-list"><li class="nav-list-item ">
                        <a href="/v0.90/understand/how/versioning-internals.html"
                           class="nav-list-link">Versioning Internals</a>
                    </li><li class="nav-list-item  active">
                        <a href="/v0.90/understand/how/kv.html"
                           class="nav-list-link active">Internal database structure</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.90/understand/how/merge.html"
                           class="nav-list-link">Merge</a>
                    </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                        <use xlink:href="#svg-arrow-right"></use>
                    </svg></a><a href="/v0.90/understand/data_lifecycle_management/"
                   class="nav-list-link">Data Lifecycle Management</a><ul class="nav-list"><li class="nav-list-item ">
                        <a href="/v0.90/understand/data_lifecycle_management/data-devenv.html"
                           class="nav-list-link">In Test</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.90/understand/data_lifecycle_management/ci.html"
                           class="nav-list-link">During Deployment</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.90/understand/data_lifecycle_management/production.html"
                           class="nav-list-link">In Production</a>
                    </li></ul></li><li class="nav-list-item "><a href="/v0.90/understand/glossary.html"
                   class="nav-list-link">Glossary</a></li></ul></li><li
            class="nav-list-item"><a href="/v0.90/roadmap.html"
           class="nav-list-link">Roadmap</a></li><li
            class="nav-list-item"><a href="/v0.90/commitment.html"
           class="nav-list-link">Commitment to OSS</a></li><li
            class="nav-list-item"><a href="/v0.90/contributing.html"
           class="nav-list-link">Contributing</a></li><li
            class="nav-list-item"><a href="/v0.90/faq.html"
           class="nav-list-link">FAQ</a></li></ul>
            <div class="mobile-menu">
                
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

            </div>
        </nav>

    </div>
    <div class="main" id="top">
         <div class="feedback-container">
            <div id="is-helpful-ty">
                <div class="text-epsilon">Thank you for your feedback.</div>
                <div class="mt-2 text-epsilon">
                    <a href="https://lakefs.io/slack" target="_blank">Join the community</a> to get more help.
                </div>
            </div>
            <div class="feedback-buttons">
                <span class="tooltip">
                    <button class="page-helpful-btn far fa-lg fa-thumbs-up" id="page-helpful-yes"></button>
                    <span class="tooltiptext">
                        This page is <b>helpful</b>
                    </span>
                </span>
                <span class="tooltip">
                    <button class="page-helpful-btn far fa-lg fa-thumbs-down" id="page-helpful-no"></button>
                    <span class="tooltiptext">
                        This page is <b>not helpful</b>
                    </span>
                </span>
            </div>
        </div>
        <div id="main-header" class="main-header">
            
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

        </div>
        <div id="main-content-wrap" class="main-content-wrap">
            
            
            <nav aria-label="Breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb-nav-list">
                    
                    <li class="breadcrumb-nav-list-item"><a
                                href="/v0.90/understand/">Understanding lakeFS</a>
                    </li>
                    <li class="breadcrumb-nav-list-item"><a href="/v0.90/understand/how/">How it Works</a>
                    </li>
                    
                    <li class="breadcrumb-nav-list-item"><span>Internal database structure</span></li>
                </ol>
            </nav>
            
            
            <div id="main-content" class="main-content" role="main">
                
                <h1 class="no_toc" id="internal-database-structure">
  
  
    <a href="#internal-database-structure" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Internal database structure
  
  
</h1>
    

<div class="toc-block">
<h2 class="no_toc text-delta" id="table-of-contents">
  
  
    <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
  
  
</h2>
    

<ol id="markdown-toc">
  <li><a href="#optimistic-locking-with-kv" id="markdown-toc-optimistic-locking-with-kv">Optimistic Locking with KV</a></li>
  <li><a href="#db-transactions-and-atomic-updates" id="markdown-toc-db-transactions-and-atomic-updates">DB Transactions and Atomic Updates</a></li>
  <li><a href="#so-which-approach-is-better" id="markdown-toc-so-which-approach-is-better">So, Which Approach is Better?</a></li>
</ol>

</div>

<p>Starting at version 0.80.2, lakeFS abandoned the tight coupling to <a href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> and moved all database operations to work over <a href="https://en.wikipedia.org/wiki/Key%E2%80%93value_database">Key-Value Store</a></p>

<p>While SQL databases, and Postgres among them, have their obvious advantages, we felt that the tight coupling to Postgres is limiting our users and so, lakeFS with Key Value Store is introduced.
Our KV Store implements a generic interface, with methods for <code class="language-plaintext highlighter-rouge">Get</code>, <code class="language-plaintext highlighter-rouge">Set</code>, <code class="language-plaintext highlighter-rouge">Compare-and-Set</code>, <code class="language-plaintext highlighter-rouge">Delete</code> and <code class="language-plaintext highlighter-rouge">Scan</code>. Each entry is represented by a [<code class="language-plaintext highlighter-rouge">partition</code>, <code class="language-plaintext highlighter-rouge">key</code>, <code class="language-plaintext highlighter-rouge">value</code>] triplet. All these fields are generic byte-array, and the using module has maximal flexibility on the format to use for each field</p>

<p>Under the hood, our KV implementation relies on a backing DB, which persists the data. Theoretically, it could be any type of database and out of the box, we already implemented drivers for <a href="https://en.wikipedia.org/wiki/Amazon_DynamoDB">DynamoDB</a>, for AWS users, and <a href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a>, using its relational nature to store a KV Store. More databases will be supported in the future, and lakeFS users and contributors can develop their own driver to use their own favorite database. For experimenting purposes, an in-memory KV store can be used, though it obviously lack the persistency aspect</p>

<p>In order to store its metadata objects (that is <code class="language-plaintext highlighter-rouge">Repositories</code>, <code class="language-plaintext highlighter-rouge">Branches</code>, <code class="language-plaintext highlighter-rouge">Commits</code>, <code class="language-plaintext highlighter-rouge">Tags</code>, and <code class="language-plaintext highlighter-rouge">Uncommitted Objects</code>), lakeFS implements another layer over the generic KV Store, which supports serialization and deserialization of these objects as <a href="https://en.wikipedia.org/wiki/Protocol_Buffers">protobuf</a>. As this layer relies on the generic interface of the KV Store layer, it is totally agnostic to whichever store implementation is in use, gaining our users the maximal flexibility</p>

<p>For further reading, please refer to our <a href="https://github.com/treeverse/lakeFS/blob/master/design/accepted/metadata_kv/index.md">KV Design</a></p>
<h2 id="optimistic-locking-with-kv">
  
  
    <a href="#optimistic-locking-with-kv" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optimistic Locking with KV
  
  
</h2>
    

<p>One important key difference between SQL databases and Key Value Store is the ability to lock resources. While this is a common practice with relational databases, Key Value stores not always support this ability. When designing our KV Store, we tried to support the most simplistic straight-forward interface, with flexibility in backing DB selection, and so, we decided not to support locking. This decision brought some concurrency challenges we had to overcome. Let us take a look at a common lakeFS flow, <code class="language-plaintext highlighter-rouge">Commit</code>, during which several database operations are performed:</p>
<ul>
  <li>All relevant (<code class="language-plaintext highlighter-rouge">Branch</code> correlated) uncommitted objects are collected and marked as committed</li>
  <li>A new <code class="language-plaintext highlighter-rouge">Commit</code> object is created</li>
  <li>The relevant <code class="language-plaintext highlighter-rouge">Branch</code> is updated to point to the new commit</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">Commit</code> flow includes multiple database accesses and modifications, and is very sensitive to concurrent executions: If 2 <code class="language-plaintext highlighter-rouge">Commit</code> flows run in parallel, we must guarantee correctness of the data. <code class="language-plaintext highlighter-rouge">lakeFS</code> with PostgreSQL simply locks the <code class="language-plaintext highlighter-rouge">Branch</code> for the entire <code class="language-plaintext highlighter-rouge">Commit</code> operation, preventing concurrent execution of such flows.
Now, with KV Store replacing the SQL database, this easy solution is no longer available. Instead, we implemented an <a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control">Optimistic Locking</a> algorithm, which leverages the KV Store <code class="language-plaintext highlighter-rouge">Compare-And-Set</code> (<code class="language-plaintext highlighter-rouge">CAS</code>) functionality to remember the <code class="language-plaintext highlighter-rouge">Branch</code> state at the beginning of the <code class="language-plaintext highlighter-rouge">Commit</code> flow, and updating the branch at the end, only if it remains unchanged, using <code class="language-plaintext highlighter-rouge">CAS</code>, with the former <code class="language-plaintext highlighter-rouge">Branch</code> state, used as a comparison criteria. If the sampled <code class="language-plaintext highlighter-rouge">Branch</code> state and the current state differ, it could only mean that another, later, <code class="language-plaintext highlighter-rouge">Commit</code> is in progress, causing the first <code class="language-plaintext highlighter-rouge">Commit</code> to fail, and give the later <code class="language-plaintext highlighter-rouge">Commit</code> a chance to complete.
Here’s a running example:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Commit</code> A sets the <code class="language-plaintext highlighter-rouge">StagingToken</code> to tokenA and samples the <code class="language-plaintext highlighter-rouge">Branch</code>,</li>
  <li><code class="language-plaintext highlighter-rouge">Commit</code> B sets the <code class="language-plaintext highlighter-rouge">StagingToken</code> to tokenB and samples the <code class="language-plaintext highlighter-rouge">Branch</code>,</li>
  <li><code class="language-plaintext highlighter-rouge">Commit</code> A finishes, tries to update the <code class="language-plaintext highlighter-rouge">Branch</code> and fails due to the recent modification by <code class="language-plaintext highlighter-rouge">Commit</code> B - the <code class="language-plaintext highlighter-rouge">StagingToken</code> is set to tokenB and not tokenA as expected by <code class="language-plaintext highlighter-rouge">Commit</code> A,</li>
  <li><code class="language-plaintext highlighter-rouge">Commit</code> B finishes and updates the branch, as tokenB is set as <code class="language-plaintext highlighter-rouge">StagingToken</code> and it matches the flow expectation</li>
</ul>

<p>An important detail to note, is that as a <code class="language-plaintext highlighter-rouge">Commit</code> starts, and the <code class="language-plaintext highlighter-rouge">StagingToken</code> is set a new value, the former value is added to a list of ‘still valid’ <code class="language-plaintext highlighter-rouge">StagingToken</code>s - <code class="language-plaintext highlighter-rouge">SealedToken</code> - on the <code class="language-plaintext highlighter-rouge">Branch</code>, which makes sure no <code class="language-plaintext highlighter-rouge">StagingToken</code> and no object are lost due to a failed <code class="language-plaintext highlighter-rouge">Commit</code></p>

<p>You can read more on the Commit Flow in the <a href="https://github.com/treeverse/lakeFS/blob/master/design/accepted/metadata_kv/index.md#graveler-metadata---branches-and-staged-writes">dedicated section in the KV Design</a></p>
<h2 id="db-transactions-and-atomic-updates">
  
  
    <a href="#db-transactions-and-atomic-updates" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DB Transactions and Atomic Updates
  
  
</h2>
    

<p>Another notable difference is the existence of DB transactions with PostgreSQL, ability that our KV Store lacks. This ability was leveraged by <code class="language-plaintext highlighter-rouge">lakeFS</code> to construct several DB updates, into one “atomic” operation - each failure, in each step, rolled back the entire operation, keeping the DB consistent and clean.
With KV Store, this ability is gone, and we had to come up with various solutions. As a starting point, the DB consistency is, obviously, not anything we can risk. On the other hand, maintaining the DB clean, and as a result smaller, is something that can be sacrificed, at least as a first step. Let us take a look at a relatively simple flow of a new <code class="language-plaintext highlighter-rouge">Repository</code> creation:
A brand new <code class="language-plaintext highlighter-rouge">Repository</code> has 3 objects: The <code class="language-plaintext highlighter-rouge">Repository</code> object itself, an initial <code class="language-plaintext highlighter-rouge">Branch</code> object and an initial <code class="language-plaintext highlighter-rouge">Commit</code>, which the <code class="language-plaintext highlighter-rouge">Branch</code> points to. With SQL DB, it was as simple as creating all 3 objects in the DB under one transaction (at this order). Any failure resulted in a rollback and no redundant leftovers in our DB.
With no transaction in KV Store, if for example the <code class="language-plaintext highlighter-rouge">Branch</code> creation fails, it will leave the <code class="language-plaintext highlighter-rouge">Repository</code> without an initial <code class="language-plaintext highlighter-rouge">Branch</code> (or a <code class="language-plaintext highlighter-rouge">Branch</code> at all), yet the <code class="language-plaintext highlighter-rouge">Repository</code> will be accessible. Trying to delete the <code class="language-plaintext highlighter-rouge">Repository</code> as a response to <code class="language-plaintext highlighter-rouge">Branch</code> creation failure is ony a partial solution as this operation can fail as well.
To mitigate this we introduced a per-<code class="language-plaintext highlighter-rouge">Repository</code>-partition, which holds all repository related objects (the <code class="language-plaintext highlighter-rouge">Branch</code> and <code class="language-plaintext highlighter-rouge">Commit</code> in this scenario). The partition key can only be derived from the specific<code class="language-plaintext highlighter-rouge">Repository</code> instance itself. In addition we first create the <code class="language-plaintext highlighter-rouge">Repository</code> objects, the <code class="language-plaintext highlighter-rouge">Commit</code> and the <code class="language-plaintext highlighter-rouge">Branch</code>, under the <code class="language-plaintext highlighter-rouge">Repository</code>’s partition key, and then the <code class="language-plaintext highlighter-rouge">Repository</code> is created. The <code class="language-plaintext highlighter-rouge">Repository</code> and its objects will be accessible only after a successful creation of all 3 entities. A failure in this flow might leave some dangling objects, but consistency is maintained.
The number of such dangling objects is not expected to be significant, and we plan to implement a cleaning algorithm to keep our KV Store neat and clean</p>
<h2 id="so-which-approach-is-better">
  
  
    <a href="#so-which-approach-is-better" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> So, Which Approach is Better?
  
  
</h2>
    

<p>This documents provides a peek into <code class="language-plaintext highlighter-rouge">lakeFS</code>’ new database approach - Key Value Store instead of a Relational SQL. It discusses the challenges we faced, and the solutions we provided to overcome these challenges. Considering the fact that <code class="language-plaintext highlighter-rouge">lakeFS</code> over with relational database did work, you might ask yourself why did we bother to develop another solution. The simple answer, is that while PostgreSQL was not a bad option, it was the only option, and any drawback of PostgreSQL, reflected on our users:</p>
<ul>
  <li>PostgreSQL can only scale vertically and that is a limitation. At some point this might not hold.</li>
  <li>PostgreSQL is not a managed solution, meaning that users had to take care of all maintenance tasks, including the above mentioned scale (when needed)</li>
  <li>As an unmanaged database, scaling means downtime - is that acceptable?</li>
  <li>It might even get to the point that your organization is not willing to work with PostgreSQL due to various business considerations</li>
</ul>

<p>If none of the above apply, and you have no seemingly reason to switch from PostgreSQL, it can definitely still be used as an excellent option for the backing database for <code class="language-plaintext highlighter-rouge">lakeFS</code>’s KV Store. If you do need another solution, you have DynamoDB support, out of the box. DynamoDB, as a fully managed solution, with horizontal scalability support and optimized partitions support, answers all the pain-points specified above. It is definitely an option to consider, if you need to overcome these
And, of course, you can always decide to implement your own KV Store driver to use your database of choice - we would love to add your contribution to <code class="language-plaintext highlighter-rouge">lakeFS</code></p>

                

                
                

            </div>
        </div>

        
        

        <div class="search-overlay"></div>
        
    </div>
</div>

<footer>
    <div class="footer-sidebar"></div>
    <div class="footer-main">
        <div class="row">
            <a href="https://lakefs.io" class="site-title lh-tight">
                <div class="site-logo"></div>
            </a>
        </div>
        <div class="row">
            <div class="left">
                <ul class="footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Docs
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Blog
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            GitHub
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Community
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            lakeFS Cloud
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/contact-us/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Contact
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
            <div class="right">
                <ul class="footer-social">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/youtube" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.90/assets/icons/youtube.svg" class="no-hover" />
                            <img src="/v0.90/assets/icons/youtube-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://www.linkedin.com/company/treeverse" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.90/assets/icons/linkedin.svg" class="no-hover" />
                            <img src="/v0.90/assets/icons/linkedin-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.90/assets/icons/github.svg" class="no-hover" />
                            <img src="/v0.90/assets/icons/github-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://twitter.com/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.90/assets/icons/twitter.svg" class="no-hover" />
                            <img src="/v0.90/assets/icons/twitter-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/slack" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.90/assets/icons/slack.svg" class="no-hover" />
                            <img src="/v0.90/assets/icons/slack-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row top-border">
            <div class="left"><a href="/v0.90https://www.treeverse.io/">
                    <div class="other-logo"><img src="/v0.90/assets/by-treeverse.png" /></div>
                </a></div>
            <div class="right">
                <ul class="bottom-footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/terms-of-use/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Terms of use
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/privacy-policy/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Privacy Policy
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
    </div>
</footer>


</body>

</html>

