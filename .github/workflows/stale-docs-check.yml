name: Docs - Check docs.lakefs.io matches source

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-and-compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Docs source
        uses: actions/checkout@v3
        with:
          repository: treeverse/lakeFS
          path: lakeFS

      - name: Checkout Published Docs
        uses: actions/checkout@v2
        with:
          repository: treeverse/docs-lakeFS
          path: docs-lakeFS

      - name: Setup Ruby    
        uses: ruby/setup-ruby@v1
        with:
          working-directory: lakeFS/docs
          ruby-version: '2.7'
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically

      - name: Build Docs from Source    
        working-directory: lakeFS/docs
        run: bundle exec jekyll build --config _config.yml 
  
      - name: Compare Generated Site 1
        run: |
          diff --brief --recursive docs-lakeFS lakeFS/docs/_site | \
                  grep -v --extended-regexp 'Only in docs-lakeFS: v?[[:digit:]]+(\.[[:digit:]]+)?' | \
                  grep -v -e ": .git" -e ": versions.json" -e ": CNAME" > /tmp/diffs.txt

          if [ -e "/tmp/diffs.txt" ]; then
            echo "ðŸš¨ Docs published on docs.lakefs.io don't match docs generated from source ðŸš¨"
            echo " "
            cat /tmp/diffs.txt

            mkdir -p /tmp/mismatched-files/docs-lakeFS 
            mkdir -p /tmp/mismatched-files/lakeFS/docs/_site
            while read -r line; do
              file1=$(echo "$line" | cut -d' ' -f2)
              file2=$(echo "$line" | cut -d' ' -f4)
              cp "$file1" /tmp/mismatched-files/docs-lakeFS 
              cp "$file2" /tmp/mismatched-files/lakeFS/docs/_site
            done < /tmp/diffs.txt

            exit 1
          else
            echo "âœ… Docs match"
            true
          fi

          
      - name: Compare Generated Site 2
        run: |
          pwd
          ls -l 
          diff --brief --recursive docs-lakeFS lakeFS/docs/_site > /tmp/raw_diff.txt
          pwd
          grep -v --extended-regexp 'Only in docs-lakeFS: v?[[:digit:]]+(\.[[:digit:]]+)?' /tmp/raw_diff.txt | \
          grep -v -e ": .git" \
                  -e ": versions.json" \
                  -e ": CNAME" \
                  -e "Files docs-lakeFS/assets/js/search-data.json and lakeFS/docs/_site/assets/js/search-data.json differ" \
                  -e "Files docs-lakeFS/posts/index.html and lakeFS/docs/_site/posts/index.html differ" \
                  -e "Files docs-lakeFS/redirects.json and lakeFS/docs/_site/redirects.json differ" \
                > /tmp/diffs.txt

          pwd

          if [ -e "/tmp/diffs.txt" ]; then
            echo "ðŸš¨ Docs published on docs.lakefs.io don't match docs generated from source ðŸš¨"
            echo " "
            cat /tmp/diffs.txt

            mkdir -p /tmp/mismatched-files/docs-lakeFS 
            mkdir -p /tmp/mismatched-files/lakeFS/docs/_site
            while read -r line; do
              file1=$(echo "$line" | cut -d' ' -f2)
              file2=$(echo "$line" | cut -d' ' -f4)
              cp "$file1" /tmp/mismatched-files/docs-lakeFS 
              cp "$file2" /tmp/mismatched-files/lakeFS/docs/_site
            done < /tmp/diffs.txt

            exit 1
          else
            echo "âœ… Docs match"
            true
          fi

      - name: Upload artifacts if mismatches found
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: mismatched-files
          path: |
            /tmp/mismatched-files/
            /tmp/diffs.txt