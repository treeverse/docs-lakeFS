

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <link rel="stylesheet" href="/v0.94/assets/css/just-the-docs-default.css">

  

  
    <script src="/v0.94/assets/js/vendor/lunr.min.js"></script>
  

  

  <script src="/v0.94/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
    <link rel="icon" href="/v0.94/favicon.ico" type="image/x-icon">
  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Versioning Internals | lakeFS</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Versioning Internals" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This section explains how versioning works in lakeFS." />
<meta property="og:description" content="This section explains how versioning works in lakeFS." />
<meta property="og:site_name" content="lakeFS" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Versioning Internals" />
<script type="application/ld+json">
{"description":"This section explains how versioning works in lakeFS.","@type":"WebPage","headline":"Versioning Internals","url":"/v0.94/understand/how/versioning-internals.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/v0.94/assets/logo.svg"}},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Google Tag Manager Head -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KTZBZW9');</script>
<!-- End Google Tag Manager Head -->
<meta name="robots" content="noindex">
<meta property="og:image" content="/v0.94/assets/img/shared-image.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/fontawesome.min.css" integrity="sha512-giQeaPns4lQTBMRpOOHsYnGw1tGVzbAIHUyHRgn7+6FmiEgGGjaG0T2LZJmAPMzRCl+Cug0ItQ2xDZpTmEc+CQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script src="/v0.94/assets/js/copy-code.js"></script>
<script>
    $(function () {
        $(".tabs").tabs();
    });
</script>
<script src="/v0.94/assets/js/feedback.js"></script>
<link href="https://data-folks.masto.host/@lakeFS" rel="me">

</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KTZBZW9"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-link">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-search">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="16px" viewBox="0 0 20 16" version="1.1"
             class="feather feather-menu">
            <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="header-/-mobile" transform="translate(-30.000000, -32.000000)" fill="#279890">
                    <g id="Group" transform="translate(30.000000, 32.000000)">
                        <path
                                d="M20,14 L20,16 L0,16 L0,14 L20,14 Z M20,7 L20,9 L0,9 L0,7 L20,7 Z M20,0 L20,2 L0,2 L0,0 L20,0 Z"
                                id="mobile-menu" />
                    </g>
                </g>
            </g>
        </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-chevron-right">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-file">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
    </symbol>
</svg>
<div class="body-wrapper">
    <div class="side-bar">
        <div class="site-header">
            <a href="https://lakefs.io" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
            <a href="#" id="menu-button" class="site-button">
                <svg viewBox="0 0 24 24" class="icon">
                    <use xlink:href="#svg-menu"></use>
                </svg>
            </a>
        </div>
        <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
            
            <div class="search">
                <div class="search-input-wrap">
                    <input type="text" id="search-input" class="search-input" tabindex="0"
                           placeholder="Search lakeFS" aria-label="Search lakeFS"
                           autocomplete="off">
                    <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon">
                            <use xlink:href="#svg-search"></use>
                        </svg></label>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
            

            <div class="nav-category nav-version">
                <label for="selectversion">Version:</label>
                <select id="selectversion" name="version" onchange="javascript:location.href = '/' + encodeURI(this.value);">
                    <option value="" selected>Latest</option>
                </select>
            </div>
            <script async>
                window.addEventListener("load",  async () => {
                    const pathFirstLevel = location.pathname.split('/')[1];
                    const selectedVersion = pathFirstLevel.startsWith('v') && pathFirstLevel || '';
                    const selectVersionElmFirst = document.getElementById('selectversion').firstElementChild;
                    const response = await fetch('/versions.json');
                    if (!response.ok) {
                        return
                    }
                    const versions = await response.json();
                    for (let [key, value] of Object.entries(versions)) {
                        const el = document.createElement("option");
                        el.value = key;
                        el.textContent = value;
                        if (key === selectedVersion) {
                            el.selected = true;
                        }
                        selectVersionElmFirst.after(el);
                    }
                });
            </script>

            <ul class="nav-list"><li
            class="nav-list-item"><a href="/v0.94/"
           class="nav-list-link">What is lakeFS</a></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/quickstart/"
           class="nav-list-link">Quickstart</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/quickstart/run.html"
                   class="nav-list-link">Run lakeFS</a></li><li class="nav-list-item "><a href="/v0.94/quickstart/repository.html"
                   class="nav-list-link">Create a Repository</a></li><li class="nav-list-item "><a href="/v0.94/quickstart/add_data.html"
                   class="nav-list-link">Add Data</a></li><li class="nav-list-item "><a href="/v0.94/quickstart/first_commit.html"
                   class="nav-list-link">Commit the Changes</a></li><li class="nav-list-item "><a href="/v0.94/quickstart/more_quickstart_options.html"
                   class="nav-list-link">More Quickstart Options</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/deploy/"
           class="nav-list-link">Deploy and Setup lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/deploy/aws.html"
                   class="nav-list-link">AWS</a></li><li class="nav-list-item "><a href="/v0.94/deploy/azure.html"
                   class="nav-list-link">Azure</a></li><li class="nav-list-item "><a href="/v0.94/deploy/gcp.html"
                   class="nav-list-link">GCP</a></li><li class="nav-list-item "><a href="/v0.94/deploy/onprem.html"
                   class="nav-list-link">On-Prem</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/integrations/"
           class="nav-list-link">Integrations</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/integrations/spark.html"
                   class="nav-list-link">Spark</a></li><li class="nav-list-item "><a href="/v0.94/integrations/delta.html"
                   class="nav-list-link">Delta Lake</a></li><li class="nav-list-item "><a href="/v0.94/integrations/aws_cli.html"
                   class="nav-list-link">AWS CLI</a></li><li class="nav-list-item "><a href="/v0.94/integrations/airflow.html"
                   class="nav-list-link">Airflow</a></li><li class="nav-list-item "><a href="/v0.94/integrations/python.html"
                   class="nav-list-link">Python</a></li><li class="nav-list-item "><a href="/v0.94/integrations/duckdb.html"
                   class="nav-list-link">DuckDB</a></li><li class="nav-list-item "><a href="/v0.94/integrations/glue_hive_metastore.html"
                   class="nav-list-link">Glue / Hive metastore</a></li><li class="nav-list-item "><a href="/v0.94/integrations/presto_trino.html"
                   class="nav-list-link">Presto/Trino</a></li><li class="nav-list-item "><a href="/v0.94/integrations/athena.html"
                   class="nav-list-link">Amazon Athena</a></li><li class="nav-list-item "><a href="/v0.94/integrations/kubeflow.html"
                   class="nav-list-link">Kubeflow</a></li><li class="nav-list-item "><a href="/v0.94/integrations/airbyte.html"
                   class="nav-list-link">Airbyte</a></li><li class="nav-list-item "><a href="/v0.94/integrations/dbt.html"
                   class="nav-list-link">dbt</a></li><li class="nav-list-item "><a href="/v0.94/integrations/kakfa.html"
                   class="nav-list-link">Kafka</a></li><li class="nav-list-item "><a href="/v0.94/integrations/sagemaker.html"
                   class="nav-list-link">SageMaker</a></li><li class="nav-list-item "><a href="/v0.94/integrations/hive.html"
                   class="nav-list-link">Hive</a></li><li class="nav-list-item "><a href="/v0.94/integrations/dremio.html"
                   class="nav-list-link">Dremio</a></li><li class="nav-list-item "><a href="/v0.94/integrations/iceberg.html"
                   class="nav-list-link">Iceberg</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/hooks/"
           class="nav-list-link">Hooks</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/hooks/overview.html"
                   class="nav-list-link">Overview</a></li><li class="nav-list-item "><a href="/v0.94/hooks/lua.html"
                   class="nav-list-link">Lua</a></li><li class="nav-list-item "><a href="/v0.94/hooks/webhooks.html"
                   class="nav-list-link">Webhooks</a></li><li class="nav-list-item "><a href="/v0.94/hooks/airflow.html"
                   class="nav-list-link">Airflow</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/use_cases/"
           class="nav-list-link">Use Cases</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/use_cases/etl_testing.html"
                   class="nav-list-link">ETL Testing Environment</a></li><li class="nav-list-item "><a href="/v0.94/use_cases/rollback.html"
                   class="nav-list-link">Rollback</a></li><li class="nav-list-item "><a href="/v0.94/use_cases/reproducibility.html"
                   class="nav-list-link">Reproducibility</a></li><li class="nav-list-item "><a href="/v0.94/use_cases/cicd_for_data.html"
                   class="nav-list-link">CI/CD for data lakes</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/howto/"
           class="nav-list-link">How-To</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/howto/import.html"
                   class="nav-list-link">Import data into lakeFS</a></li><li class="nav-list-item "><a href="/v0.94/howto/garbage-collection.html"
                   class="nav-list-link">Garbage Collection</a></li><li class="nav-list-item "><a href="/v0.94/howto/upgrade.html"
                   class="nav-list-link">Upgrade lakeFS</a></li><li class="nav-list-item "><a href="/v0.94/howto/export.html"
                   class="nav-list-link">Exporting Data</a></li><li class="nav-list-item "><a href="/v0.94/howto/copying.html"
                   class="nav-list-link">Copying data to/from lakeFS</a></li><li class="nav-list-item "><a href="/v0.94/howto/protect-branches.html"
                   class="nav-list-link">Protect Branches</a></li><li class="nav-list-item "><a href="/v0.94/howto/migrate-away.html"
                   class="nav-list-link">Migrating away from lakeFS</a></li><li class="nav-list-item "><a href="/v0.94/howto/sizing-guide.html"
                   class="nav-list-link">Sizing Guide</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/reference/"
           class="nav-list-link">Reference</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/reference/configuration.html"
                   class="nav-list-link">Configuration</a></li><li class="nav-list-item "><a href="/v0.94/reference/cli.html"
                   class="nav-list-link">CLI (lakectl)</a></li><li class="nav-list-item "><a href="/v0.94/reference/api.html"
                   class="nav-list-link">API Reference</a></li><li class="nav-list-item "><a href="/v0.94/reference/spark-client.html"
                   class="nav-list-link">Spark Client</a></li><li class="nav-list-item "><a href="/v0.94/reference/s3.html"
                   class="nav-list-link">S3 Supported API</a></li><li class="nav-list-item "><a href="/v0.94/reference/authentication.html"
                   class="nav-list-link">Authentication</a></li><li class="nav-list-item "><a href="/v0.94/reference/saml-authentication-integration.html"
                   class="nav-list-link">SAML Authentication Integration</a></li><li class="nav-list-item "><a href="/v0.94/reference/authorization.html"
                   class="nav-list-link">Authorization</a></li><li class="nav-list-item "><a href="/v0.94/reference/monitor.html"
                   class="nav-list-link">Monitoring using Prometheus</a></li></ul></li><li
            class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/v0.94/understand/"
           class="nav-list-link">Understanding lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/v0.94/understand/architecture.html"
                   class="nav-list-link">Architecture</a></li><li class="nav-list-item "><a href="/v0.94/understand/model.html"
                   class="nav-list-link">Model</a></li><li class="nav-list-item "><a href="/v0.94/understand/performance-best-practices.html"
                   class="nav-list-link">Performance Best Practices</a></li><li class="nav-list-item  active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                        <use xlink:href="#svg-arrow-right"></use>
                    </svg></a><a href="/v0.94/understand/how/"
                   class="nav-list-link">How it Works</a><ul class="nav-list"><li class="nav-list-item  active">
                        <a href="/v0.94/understand/how/versioning-internals.html"
                           class="nav-list-link active">Versioning Internals</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.94/understand/how/kv.html"
                           class="nav-list-link">Internal database structure</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.94/understand/how/merge.html"
                           class="nav-list-link">Merge</a>
                    </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                        <use xlink:href="#svg-arrow-right"></use>
                    </svg></a><a href="/v0.94/understand/data_lifecycle_management/"
                   class="nav-list-link">Data Lifecycle Management</a><ul class="nav-list"><li class="nav-list-item ">
                        <a href="/v0.94/understand/data_lifecycle_management/data-devenv.html"
                           class="nav-list-link">In Test</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.94/understand/data_lifecycle_management/ci.html"
                           class="nav-list-link">During Deployment</a>
                    </li><li class="nav-list-item ">
                        <a href="/v0.94/understand/data_lifecycle_management/production.html"
                           class="nav-list-link">In Production</a>
                    </li></ul></li><li class="nav-list-item "><a href="/v0.94/understand/glossary.html"
                   class="nav-list-link">Glossary</a></li></ul></li><li
            class="nav-list-item"><a href="/v0.94/roadmap.html"
           class="nav-list-link">Roadmap</a></li><li
            class="nav-list-item"><a href="/v0.94/commitment.html"
           class="nav-list-link">Commitment to OSS</a></li><li
            class="nav-list-item"><a href="/v0.94/audit.html"
           class="nav-list-link">Audit</a></li><li
            class="nav-list-item"><a href="/v0.94/contributing.html"
           class="nav-list-link">Contributing</a></li><li
            class="nav-list-item"><a href="/v0.94/faq.html"
           class="nav-list-link">FAQ</a></li></ul>
            <div class="mobile-menu">
                
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

            </div>
        </nav>

    </div>
    <div class="main" id="top">
         <div class="feedback-container">
            <div id="is-helpful-ty">
                <div class="text-epsilon">Thank you for your feedback.</div>
                <div class="mt-2 text-epsilon">
                    <a href="https://lakefs.io/slack" target="_blank">Join the community</a> to get more help.
                </div>
            </div>
            <div class="feedback-buttons">
                <span class="tooltip">
                    <button class="page-helpful-btn far fa-lg fa-thumbs-up" id="page-helpful-yes"></button>
                    <span class="tooltiptext">
                        This page is <b>helpful</b>
                    </span>
                </span>
                <span class="tooltip">
                    <button class="page-helpful-btn far fa-lg fa-thumbs-down" id="page-helpful-no"></button>
                    <span class="tooltiptext">
                        This page is <b>not helpful</b>
                    </span>
                </span>
            </div>
        </div>
        <div id="main-header" class="main-header">
            
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

        </div>
        <div id="main-content-wrap" class="main-content-wrap">
            
            
            <nav aria-label="Breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb-nav-list">
                    
                    <li class="breadcrumb-nav-list-item"><a
                                href="/v0.94/understand/">Understanding lakeFS</a>
                    </li>
                    <li class="breadcrumb-nav-list-item"><a href="/v0.94/understand/how/">How it Works</a>
                    </li>
                    
                    <li class="breadcrumb-nav-list-item"><span>Versioning Internals</span></li>
                </ol>
            </nav>
            
            
            <div id="main-content" class="main-content" role="main">
                
                <h1 class="no_toc" id="versioning-internals">
  
  
    <a href="#versioning-internals" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Versioning Internals
  
  
</h1>
    

<div class="toc-block">
<h2 class="no_toc text-delta" id="table-of-contents">
  
  
    <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
  
  
</h2>
    

<ol id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#sstable-file-format-graveler-file" id="markdown-toc-sstable-file-format-graveler-file">SSTable File Format (“Graveler File”)</a></li>
  <li><a href="#constructing-a-consistent-view-of-the-keyspace-ie-a-commit" id="markdown-toc-constructing-a-consistent-view-of-the-keyspace-ie-a-commit">Constructing a consistent view of the keyspace (i.e., a commit)</a></li>
  <li><a href="#representing-references-and-uncommitted-metadata" id="markdown-toc-representing-references-and-uncommitted-metadata">Representing references and uncommitted metadata</a></li>
</ol>

</div>
<h2 id="overview">
  
  
    <a href="#overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h2>
    

<p>Since commits in lakeFS are immutable, they are easy to store on an immutable object store.</p>

<p>Older commits are rarely accessed, while newer commits are accessed very frequently, a tiered storage approach can work very well - the object store is the source of truth, while local disk and even RAM can be used to cache the more frequently accessed ones.</p>

<p>Since they are immutable - once cached, you only need to evict them when space is running out. There’s no complex invalidation that needs to happen.</p>

<p>In terms of storage format, commits are be stored as <a href="https://en.wikipedia.org/wiki/Log-structured_merge-tree" target="_blank">SSTables</a>, compatible with <a href="https://rocksdb.org/" target="_blank">RocksDB</a>.</p>

<p>SSTables were chosen as a storage format for 3 major reasons:</p>

<ol>
  <li>Extremely high read throughput on modern hardware: using commits representing a 200m object repository (modeled after the S3 inventory of one of our design partners), we were able to achieve close to 500k random GetObject calls / second. This provides a very high throughput/cost ratio, probably as high as can be achieved on public clouds.</li>
  <li>Being a known storage format means it’s relatively easy to generate and consume. Storing it in the object store makes it accessible to data engineering tools for analysis and distributed computation, effectively reducing the silo effect of storing it in an operational database.</li>
  <li>The SSTable format supports <a href="https://github.com/facebook/rocksdb/wiki/PlainTable-Format#prefix-encoding" target="_blank">delta encoding for keys</a> which makes them very space efficient for data lakes where many keys share the same common prefixes.</li>
</ol>

<p>Each lakeFS commit is represented as a set of contiguous, non-overlapping SSTables that make up the entire keyspace of a repository at that commit.</p>
<h2 id="sstable-file-format-graveler-file">
  
  
    <a href="#sstable-file-format-graveler-file" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SSTable File Format (“Graveler File”)
  
  
</h2>
    

<p>lakeFS metadata is encoded into a format called <strong>“Graveler”</strong> - a standardized way to encode content-addressable key value pairs. This is what a Graveler file looks like:</p>

<p><img src="/v0.94/assets/img/graveler1.png" alt="Graveler File" /></p>

<p>Each Key/Value pair (<strong>“ValueRecord”</strong>) is constructed of a <code class="language-plaintext highlighter-rouge">key</code>, <code class="language-plaintext highlighter-rouge">identity</code>, and <code class="language-plaintext highlighter-rouge">value</code>.</p>

<p>A simple identity could be, for example, a sha256 hash of the value’s bytes. It could be any sequence of bytes that uniquely identifies the value. As far as the Graveler is concerned, two <code class="language-plaintext highlighter-rouge">ValueRecord</code>s are considered identical if their key and identity fields are equal.</p>

<p>A Graveler file itself is content-addressable, i.e., similarly to Git, the name of the file is its identity.
File identity is calculated based on the identity of the ValueRecords the file contains:</p>

<p><b>valueRecordID = h(h(valueRecord.key) || h(valueRecord.Identity))</b><br />
<b>fileID = h(valueRecordID<sub>1</sub> + … + valueRecordID<sub>N</sub>)</b></p>
<h2 id="constructing-a-consistent-view-of-the-keyspace-ie-a-commit">
  
  
    <a href="#constructing-a-consistent-view-of-the-keyspace-ie-a-commit" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Constructing a consistent view of the keyspace (i.e., a commit)
  
  
</h2>
    

<p>We have two additional requirements for the storage format:</p>

<ol>
  <li>Be space and time efficient when creating a commit - assuming a commit changes a single object out of a billion, we don’t want to write a full snapshot of the entire repository. Ideally, we’ll be able to reuse some data files that haven’t changed to make the commit operations (in both space and time) proportional to the size of the difference as opposed to the total size of the repository.</li>
  <li>Allow an efficient diff between commits which runs in time proportional to the size of their difference and not their absolute sizes.</li>
</ol>

<p>To support these requirements, we decided to essentially build a 2-layer <a href="https://en.wikipedia.org/wiki/Merkle_tree" target="_blank">Merkle tree</a> composed of a set of leaf nodes (<strong>“Range”</strong>) addressed by their content address, and a <strong>“Meta Range”</strong>, which is a special range containing all ranges, thus representing an entire consistent view of the keyspace:</p>

<p><img src="/v0.94/assets/img/graveler2.png" alt="Metarange to ranges relationship" /></p>

<p>Assuming commit B is derived from commit A, and only changed files in range <code class="language-plaintext highlighter-rouge">e-f</code>, it can reuse all ranges except for SSTable #N (the one containing the modified range of keys), which will be recreated with a new hash representing the state as exists after applying commit B’s changes. This will, in turn, also create a new Metarange since its hash is now changed as well (as it is derived from the hash of all contained ranges).</p>

<p>Assuming most commits usually change related objects (i.e., that are likely to share some common prefix), the reuse ratio could be very high. We tested this assumption using S3 inventory from 2 design partners - we partitioned the keyspace to an arbitrary number of simulated blocks and measured their change over time. We saw a daily change rate of about 5-20%.</p>

<p>Given the size of the repositories, it’s safe to assume that a single day would translate into multiple commits. At a modest 20 commits per day, a commit is expected to reuse &gt;= 99% of the previous commit blocks, so acceptable in terms of write amplification generated on commit.</p>

<p>On the object store, ranges are stored in the following hierarchy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;lakefs root&gt;
    _lakefs/
        &lt;range hash1&gt;
        &lt;range hash2&gt;
        &lt;range hashN&gt;
        ...
        &lt;metarange hash1&gt;
        &lt;metarange hash2&gt;
        &lt;metarange hashN&gt;
        ...
    &lt;data object hash1&gt;
    &lt;data object hash2&gt;
    &lt;data object hashN&gt;
    ...
</code></pre></div></div>

<p><em>Note: This relatively flat structure could be modified in the future. Looking at the diagram above, it imposes no real limitations on the depth of the tree. A tree could easily be made recursive by having Meta Ranges point to other Meta Ranges - and still provide all the same characteristics. For simplicity, we decided to start with a fixed 2-level hierarchy.</em></p>
<h2 id="representing-references-and-uncommitted-metadata">
  
  
    <a href="#representing-references-and-uncommitted-metadata" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Representing references and uncommitted metadata
  
  
</h2>
    

<p>lakeFS always stores the object data in the storage namespace in the user’s object store, committed and uncommitted data alike.</p>

<p>However, the lakeFS object metadata might be stored in either the object store or a key-value store.</p>

<p>Unlike committed metadata which is immutable, uncommitted (or “staged”) metadata experiences frequent random writes and is very mutable in nature. This is also true for “refs” - in particular, branches, which are simply pointers to an underlying commit, are modified frequently: on every commit or merge operation.</p>

<p>Both these types of metadata are not only mutable, but also require strong consistency guarantees while also being fault tolerant. If we can’t access the current pointer of the main branch, a big portion of the system is essentially down.</p>

<p>Luckily, this is also much smaller set of metadata compared to the committed metadata.</p>

<p>References and uncommitted metadata are currently stored on a key-value store (See <a href="/v0.94/reference/configuration.html">supported databases</a>) for consistency guarantees.</p>

                

                
                

            </div>
        </div>

        
        

        <div class="search-overlay"></div>
        
    </div>
</div>

<footer>
    <div class="footer-sidebar"></div>
    <div class="footer-main">
        <div class="row">
            <div class="left">
                <ul class="footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Docs
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Blog
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            GitHub
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Community
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            lakeFS Cloud
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/contact-us/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Contact
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
            <div class="right">
                <ul class="footer-social">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/youtube" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/youtube.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/youtube-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://www.linkedin.com/company/treeverse" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/linkedin.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/linkedin-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/github.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/github-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://twitter.com/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/twitter.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/twitter-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://data-folks.masto.host/@lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/mastodon.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/mastodon-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/slack" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/v0.94/assets/icons/slack.svg" class="no-hover" />
                            <img src="/v0.94/assets/icons/slack-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row top-border">
            <div class="left">
                <a href="https://lakefs.io" class="lh-tight" style="margin-bottom: 0px;">
                    <div class="site-logo"></div>
                </a>                    
            </div>
            <div class="right">
                <ul class="bottom-footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/terms-of-use/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Terms of use
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/privacy-policy/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Privacy Policy
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
    </div>
</footer>


</body>

</html>

