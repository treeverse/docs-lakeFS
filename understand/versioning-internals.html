

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Versioning Internals | lakeFS</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Versioning Internals" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How lakeFS does versioning" />
<meta property="og:description" content="How lakeFS does versioning" />
<meta property="og:site_name" content="lakeFS" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Versioning Internals" />
<script type="application/ld+json">
{"description":"How lakeFS does versioning","headline":"Versioning Internals","@type":"WebPage","url":"/understand/versioning-internals.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/logo.svg"}},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Google Tag Manager Head -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KTZBZW9');</script>
<!-- End Google Tag Manager Head -->
<meta property="og:image" content="/assets/img/shared-image.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/js/fontawesome.min.js" integrity="sha512-i3N2a3sMtKOQHXCJF3qEpce5twcGN9mRsWQe6PUTf9WS/eG5XkivI97uxit7B2nRGz5XuoszBaqndSqxdeVfag==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="/assets/js/copy-code.js"></script>
<script>
    $(function () {
        $(".tabs").tabs();
    });
</script>


</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KTZBZW9"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-link">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-search">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="16px" viewBox="0 0 20 16" version="1.1"
             class="feather feather-menu">
            <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="header-/-mobile" transform="translate(-30.000000, -32.000000)" fill="#279890">
                    <g id="Group" transform="translate(30.000000, 32.000000)">
                        <path
                                d="M20,14 L20,16 L0,16 L0,14 L20,14 Z M20,7 L20,9 L0,9 L0,7 L20,7 Z M20,0 L20,2 L0,2 L0,0 L20,0 Z"
                                id="mobile-menu" />
                    </g>
                </g>
            </g>
        </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-chevron-right">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="feather feather-file">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
    </symbol>
</svg>
<div class="body-wrapper">
    <div class="side-bar">
        <div class="site-header">
            <a href="https://lakefs.io" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
            <a href="#" id="menu-button" class="site-button">
                <svg viewBox="0 0 24 24" class="icon">
                    <use xlink:href="#svg-menu"></use>
                </svg>
            </a>
        </div>
        <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
            
            <div class="search">
                <div class="search-input-wrap">
                    <input type="text" id="search-input" class="search-input" tabindex="0"
                           placeholder="Search lakeFS" aria-label="Search lakeFS"
                           autocomplete="off">
                    <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon">
                            <use xlink:href="#svg-search"></use>
                        </svg></label>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
            

            <div class="nav-category nav-version">
                <label for="selectversion">Version:</label>
                <select id="selectversion" name="version" onchange="javascript:location.href = '/' + encodeURI(this.value);">
                    <option value="" selected>Latest</option>
                </select>
            </div>
            <script async>
                window.addEventListener("load",  async () => {
                    const pathFirstLevel = location.pathname.split('/')[1];
                    const selectedVersion = pathFirstLevel.startsWith('v') && pathFirstLevel || '';
                    const selectVersionElmFirst = document.getElementById('selectversion').firstElementChild;
                    const response = await fetch('/versions.json');
                    if (!response.ok) {
                        return
                    }
                    const versions = await response.json();
                    for (let [key, value] of Object.entries(versions)) {
                        const el = document.createElement("option");
                        el.value = key;
                        el.textContent = value;
                        if (key === selectedVersion) {
                            el.selected = true;
                        }
                        selectVersionElmFirst.after(el);
                    }
                });
            </script>

            <ul class="nav-list"><li
            class="nav-list-item"><a href="/"
           class="nav-list-link">What is lakeFS</a></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/quickstart/"
           class="nav-list-link">Quickstart</a><ul class="nav-list "><li class="nav-list-item "><a href="/quickstart/try.html"
                   class="nav-list-link">Try without installing</a></li><li class="nav-list-item "><a href="/quickstart/installing.html"
                   class="nav-list-link">Install lakeFS</a></li><li class="nav-list-item "><a href="/quickstart/repository.html"
                   class="nav-list-link">Create a Repository</a></li><li class="nav-list-item "><a href="/quickstart/add_data.html"
                   class="nav-list-link">Add Data</a></li><li class="nav-list-item "><a href="/quickstart/first_commit.html"
                   class="nav-list-link">Commit the Changes</a></li><li class="nav-list-item "><a href="/quickstart/more_quickstart_options.html"
                   class="nav-list-link">More Quickstart Options</a></li><li class="nav-list-item "><a href="/quickstart/iso_env.html"
                   class="nav-list-link">Tutorial – Isolated Environment</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/deploy/"
           class="nav-list-link">Deploy lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/deploy/aws.html"
                   class="nav-list-link">On AWS</a></li><li class="nav-list-item "><a href="/deploy/azure.html"
                   class="nav-list-link">On Azure</a></li><li class="nav-list-item "><a href="/deploy/gcp.html"
                   class="nav-list-link">On GCP</a></li><li class="nav-list-item "><a href="/deploy/k8s.html"
                   class="nav-list-link">With Kubernetes</a></li><li class="nav-list-item "><a href="/deploy/docker.html"
                   class="nav-list-link">With Docker</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/setup/"
           class="nav-list-link">Setup lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                        <use xlink:href="#svg-arrow-right"></use>
                    </svg></a><a href="/setup/storage/"
                   class="nav-list-link">Prepare Your Storage</a><ul class="nav-list"><li class="nav-list-item ">
                        <a href="/setup/storage/s3.html"
                           class="nav-list-link">AWS S3</a>
                    </li><li class="nav-list-item ">
                        <a href="/setup/storage/gcs.html"
                           class="nav-list-link">Google Cloud Storage</a>
                    </li><li class="nav-list-item ">
                        <a href="/setup/storage/blob.html"
                           class="nav-list-link">Azure Blob Storage</a>
                    </li></ul></li><li class="nav-list-item "><a href="/setup/create-repo.html"
                   class="nav-list-link">Create a Repository</a></li><li class="nav-list-item "><a href="/setup/import.html"
                   class="nav-list-link">Import data into lakeFS</a></li><li class="nav-list-item "><a href="/setup/hooks.html"
                   class="nav-list-link">Hooks</a></li><li class="nav-list-item "><a href="/setup/virtual-host-addressing.html"
                   class="nav-list-link">S3 Virtual-host addressing (advanced)</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/usecases/"
           class="nav-list-link">Using lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/usecases/data-devenv.html"
                   class="nav-list-link">In Development</a></li><li class="nav-list-item "><a href="/usecases/ci.html"
                   class="nav-list-link">During Deployment</a></li><li class="nav-list-item "><a href="/usecases/production.html"
                   class="nav-list-link">In Production</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/reference/"
           class="nav-list-link">Reference</a><ul class="nav-list "><li class="nav-list-item "><a href="/reference/api.html"
                   class="nav-list-link">API Reference</a></li><li class="nav-list-item "><a href="/reference/s3.html"
                   class="nav-list-link">S3 Supported API</a></li><li class="nav-list-item "><a href="/reference/configuration.html"
                   class="nav-list-link">Configuration Reference</a></li><li class="nav-list-item "><a href="/reference/commands.html"
                   class="nav-list-link">Command (CLI) Reference</a></li><li class="nav-list-item "><a href="/reference/protected_branches.html"
                   class="nav-list-link">Protected Branches</a></li><li class="nav-list-item "><a href="/reference/export.html"
                   class="nav-list-link">Exporting Data</a></li><li class="nav-list-item "><a href="/reference/garbage-collection.html"
                   class="nav-list-link">Garbage Collection</a></li><li class="nav-list-item "><a href="/reference/monitor.html"
                   class="nav-list-link">Monitoring using Prometheus</a></li><li class="nav-list-item "><a href="/reference/offboarding.html"
                   class="nav-list-link">Migrating away from lakeFS</a></li><li class="nav-list-item "><a href="/reference/upgrade.html"
                   class="nav-list-link">Upgrade lakeFS</a></li><li class="nav-list-item "><a href="/reference/authentication.html"
                   class="nav-list-link">Authentication</a></li><li class="nav-list-item "><a href="/reference/authorization.html"
                   class="nav-list-link">Authorization</a></li><li class="nav-list-item "><a href="/reference/spark-client.html"
                   class="nav-list-link">Spark Client</a></li></ul></li><li
            class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/integrations/"
           class="nav-list-link">Integrations</a><ul class="nav-list "><li class="nav-list-item "><a href="/integrations/distcp.html"
                   class="nav-list-link">Copying Data with DistCp</a></li><li class="nav-list-item "><a href="/integrations/rclone.html"
                   class="nav-list-link">Copying data with Rclone</a></li><li class="nav-list-item "><a href="/integrations/aws_cli.html"
                   class="nav-list-link">AWS CLI</a></li><li class="nav-list-item "><a href="/integrations/spark.html"
                   class="nav-list-link">Spark</a></li><li class="nav-list-item "><a href="/integrations/hive.html"
                   class="nav-list-link">Hive</a></li><li class="nav-list-item "><a href="/integrations/python.html"
                   class="nav-list-link">Python</a></li><li class="nav-list-item "><a href="/integrations/emr.html"
                   class="nav-list-link">EMR</a></li><li class="nav-list-item "><a href="/integrations/presto_trino.html"
                   class="nav-list-link">Presto/Trino</a></li><li class="nav-list-item "><a href="/integrations/boto.html"
                   class="nav-list-link">Boto (Python)</a></li><li class="nav-list-item "><a href="/integrations/minio.html"
                   class="nav-list-link">MinIO</a></li><li class="nav-list-item "><a href="/integrations/athena.html"
                   class="nav-list-link">Amazon Athena</a></li><li class="nav-list-item "><a href="/integrations/airflow.html"
                   class="nav-list-link">Airflow</a></li><li class="nav-list-item "><a href="/integrations/kubeflow.html"
                   class="nav-list-link">Kubeflow</a></li><li class="nav-list-item "><a href="/integrations/airbyte.html"
                   class="nav-list-link">Airbyte</a></li><li class="nav-list-item "><a href="/integrations/databricks.html"
                   class="nav-list-link">Databricks</a></li><li class="nav-list-item "><a href="/integrations/delta.html"
                   class="nav-list-link">Delta Lake</a></li><li class="nav-list-item "><a href="/integrations/dbt.html"
                   class="nav-list-link">dbt</a></li><li class="nav-list-item "><a href="/integrations/glue_hive_metastore.html"
                   class="nav-list-link">Glue / Hive metastore</a></li><li class="nav-list-item "><a href="/integrations/glue_etl.html"
                   class="nav-list-link">Glue ETL</a></li><li class="nav-list-item "><a href="/integrations/kakfa.html"
                   class="nav-list-link">Kafka</a></li><li class="nav-list-item "><a href="/integrations/mapreduce.html"
                   class="nav-list-link">MapReduce</a></li><li class="nav-list-item "><a href="/integrations/sagemaker.html"
                   class="nav-list-link">SageMaker</a></li><li class="nav-list-item "><a href="/integrations/dremio.html"
                   class="nav-list-link">Dremio</a></li></ul></li><li
            class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24">
                <use xlink:href="#svg-arrow-right"></use>
            </svg></a><a href="/understand/"
           class="nav-list-link">Understanding lakeFS</a><ul class="nav-list "><li class="nav-list-item "><a href="/understand/architecture.html"
                   class="nav-list-link">Architecture</a></li><li class="nav-list-item  active"><a href="/understand/versioning-internals.html"
                   class="nav-list-link active">Versioning Internals</a></li><li class="nav-list-item "><a href="/understand/object-model.html"
                   class="nav-list-link">Object Model</a></li><li class="nav-list-item "><a href="/understand/branching-model.html"
                   class="nav-list-link">Branching Model</a></li><li class="nav-list-item "><a href="/understand/sizing-guide.html"
                   class="nav-list-link">Sizing Guide</a></li><li class="nav-list-item "><a href="/understand/roadmap.html"
                   class="nav-list-link">Roadmap</a></li></ul></li><li
            class="nav-list-item"><a href="/commitment.html"
           class="nav-list-link">Our commitment to open source</a></li><li
            class="nav-list-item"><a href="/contributing.html"
           class="nav-list-link">Contributing</a></li><li
            class="nav-list-item"><a href="/faq.html"
           class="nav-list-link">FAQ</a></li></ul>
            <div class="mobile-menu">
                
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

            </div>
        </nav>

    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
            
<nav aria-label="Auxiliary" class="aux-nav">
    <ul class="aux-nav-list">
        
        
        <li class="aux-nav-list-item">
            <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Docs
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Blog
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                Community
            </a>
        </li>
        
        <li class="aux-nav-list-item">
            <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                GitHub
            </a>
        </li>
        
        
        
        
        <li class="aux-nav-list-item button">
            <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
               rel="noopener noreferrer" >
                lakeFS Cloud
            </a>
        </li>
        
        
    </ul>
</nav>

        </div>
        <div id="main-content-wrap" class="main-content-wrap">
            
            
            <nav aria-label="Breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb-nav-list">
                    
                    <li class="breadcrumb-nav-list-item"><a href="/understand/">Understanding lakeFS</a>
                    </li>
                    
                    <li class="breadcrumb-nav-list-item"><span>Versioning Internals</span></li>
                </ol>
            </nav>
            
            
            <div id="main-content" class="main-content" role="main">
                
                <h1 class="no_toc" id="versioning-internals">
        
        
          <a href="#versioning-internals" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Versioning Internals
        
        
      </h1>
    

<div class="toc-block">
      <h2 class="no_toc text-delta" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#sstable-file-format-graveler-file" id="markdown-toc-sstable-file-format-graveler-file">SSTable File Format (“Graveler File”)</a></li>
  <li><a href="#constructing-a-consistent-view-of-the-keyspace-ie-a-commit" id="markdown-toc-constructing-a-consistent-view-of-the-keyspace-ie-a-commit">Constructing a consistent view of the keyspace (i.e., a commit)</a></li>
  <li><a href="#representing-references-and-uncommitted-metadata" id="markdown-toc-representing-references-and-uncommitted-metadata">Representing references and uncommitted metadata</a></li>
</ol>

</div>
      <h2 id="overview">
        
        
          <a href="#overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
        
        
      </h2>
    

<p>Since commits in lakeFS are immutable, they are easy to store on an immutable object store.</p>

<p>Older commits are rarely accessed, while newer commits are accessed very frequently, a tiered storage approach can work very well - The object store is the source of truth, while local disk and even RAM can be used to cache the more frequently accessed ones.</p>

<p>Since they are immutable - once cached, we only need to evict them when space is running out. There’s no complex invalidation that needs to happen.</p>

<p>In terms of storage format, commits are be stored as <a href="https://en.wikipedia.org/wiki/Log-structured_merge-tree" target="_blank">SSTables</a>, compatible with <a href="https://rocksdb.org/" target="_blank">RocksDB</a>.</p>

<p>SSTables were chosen as a storage format for 3 major reasons:</p>

<ol>
  <li>Extremely high read throughput on modern hardware: using commits representing a 200m object repository (modeled after the S3 inventory of one of our design partners), we were able to achieve close to 500k random GetObject calls / second. This provides a very high throughput/cost ratio, probably as high as can be achieved on public clouds.</li>
  <li>Being a known storage format means it’s relatively easy to generate and consume. Storing it in the object store makes it accessible to data engineering tools for analysis and distributed computation, effectively reducing the silo effect of storing it in an operational database.</li>
  <li>The SSTable format supports <a href="https://github.com/facebook/rocksdb/wiki/PlainTable-Format#prefix-encoding" target="_blank">delta encoding for keys</a> which makes them very space efficient for data lakes where many keys share the same common prefixes.</li>
</ol>

<p>Each lakeFS commit is represented as a set of contiguous, non-overlapping SSTables that make up the entire keyspace of a repository at that commit.</p>
      <h2 id="sstable-file-format-graveler-file">
        
        
          <a href="#sstable-file-format-graveler-file" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SSTable File Format (“Graveler File”)
        
        
      </h2>
    

<p>lakeFS metadata is encoded into a format called <strong>“Graveler”</strong> - a standardized way to encode content-addressable key value pairs. This is what a Graveler file looks like:</p>

<p><img src="/assets/img/graveler1.png" alt="Graveler File" /></p>

<p>Each Key/Value pair (<strong>“ValueRecord”</strong>) is constructed of a <code class="language-plaintext highlighter-rouge">key</code>, an <code class="language-plaintext highlighter-rouge">identity</code> and a <code class="language-plaintext highlighter-rouge">value</code>.</p>

<p>A simple identity could be, for example, a sha256 hash of the value’s bytes, but it could be any sequence of bytes that uniquely identifies the value. As far as Graveler is concerned, two <code class="language-plaintext highlighter-rouge">ValueRecord</code>s are considered identical, if their key and identity fields are equal.</p>

<p>A Graveler file itself is content-addressable, i.e. similarly to Git, the name of the file is its identity.
File identity is calculated based on the identity of the ValueRecords the file contains:</p>

<p><b>valueRecordID = h(h(valueRecord.key) || h(valueRecord.Identity))</b><br />
<b>fileID = h(valueRecordID<sub>1</sub> + … + valueRecordID<sub>N</sub>)</b></p>
      <h2 id="constructing-a-consistent-view-of-the-keyspace-ie-a-commit">
        
        
          <a href="#constructing-a-consistent-view-of-the-keyspace-ie-a-commit" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Constructing a consistent view of the keyspace (i.e., a commit)
        
        
      </h2>
    

<p>We have 2 additional requirements for the storage format:</p>

<ol>
  <li>Be space and time efficient when creating a commit - assuming a commit changes a single object out of a billion, we don’t want to write a full snapshot of the entire repository. Ideally, we’ll be able to reuse some data files that haven’t changed to make the commit operations (in both space and time) proportional to the size of the difference as opposed to the total size of the repository.</li>
  <li>Allow an efficient diff between commits which runs in time proportional to the size of their difference and not their absolute sizes.</li>
</ol>

<p>To support these requirements, we decided to essentially build a 2-layer <a href="https://en.wikipedia.org/wiki/Merkle_tree" target="_blank">Merkle tree</a> composed of a set of leaf nodes (<strong>“Range”</strong>) addressed by their content address, and a <strong>“Meta Range”</strong>, which is a special range containing all ranges, thus representing an entire consistent view of the keyspace:</p>

<p><img src="/assets/img/graveler2.png" alt="Metarange to ranges relationship" /></p>

<p>Assuming commit B is derived from commit A, and only changed files in range <code class="language-plaintext highlighter-rouge">e-f</code>, it can reuse all ranges except for SSTable #N (the one containing the modified range of keys), which will be recreated with a new hash, representing the state as exists after applying commit B’s changes. This will in turn, also create a new Metarange since its hash is now changed as well (as it is derived from the hash of all contained ranges).</p>

<p>Assuming most commits usually change related objects (i.e. that are likely to share some common prefix), the reuse ratio could be very high. We tested this assumption using S3 inventory from 2 design partners - we partitioned the keyspace to an arbitrary number of simulated blocks and measured their change over time. We saw a daily change rate of about 5-20%.</p>

<p>Given the size of the repositories, it is safe to assume that a single day would translate into multiple commits. At a modest 20 commits per day, a commit is expected to reuse &gt;= 99% of the previous commit blocks, so acceptable in terms of write amplification generated on commit.</p>

<p>On the object store, ranges are stored in the following hierarchy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;lakefs root&gt;
    _lakefs/
        &lt;range hash1&gt;
        &lt;range hash2&gt;
        &lt;range hashN&gt;
        ...
        &lt;metarange hash1&gt;
        &lt;metarange hash2&gt;
        &lt;metarange hashN&gt;
        ...
    &lt;data object hash1&gt;
    &lt;data object hash2&gt;
    &lt;data object hashN&gt;
    ...
</code></pre></div></div>

<p><em>Note: this relatively flat structure could be modified in the future: looking at the diagram above, it imposes no real limitations on the depth of the tree. A tree could easily be made recursive by having Meta Ranges point to other Meta Ranges - and still provide all the same characteristics. For simplicity, we decided to start with a fixed 2-level hierarchy.</em></p>
      <h2 id="representing-references-and-uncommitted-metadata">
        
        
          <a href="#representing-references-and-uncommitted-metadata" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Representing references and uncommitted metadata
        
        
      </h2>
    

<p>lakeFS always stores the object data in the storage namespace in the user’s object store, committed and uncommitted data alike.</p>

<p>However, the lakeFS object metadata might be stored in either the object store or PostgresSQL.</p>

<p>Unlike committed metadata which is immutable, uncommitted (or “staged”) metadata experiences frequent random writes and is very mutable in nature. This is also true for “refs” - in particular, branches, which are simply pointers to an underlying commit, are modified frequently: on every commit or merge operation.</p>

<p>Both these types of metadata are not only mutable, but also require strong consistency guarantees while also being fault tolerant. If we can’t access the current pointer of the main branch, a big portion of the system is essentially down.</p>

<p>Luckily, this is also much smaller set of metadata, compared to the committed metadata.</p>

<p>References and uncommitted metadata are currently stored on PostgreSQL for its strong consistency and transactional guarantees.</p>

<p><a href="/understand/roadmap.html#decouple-ref-store-from-postgresql">In the future</a> we plan on eliminating the need for an RDBMS by using a pluggable Key-Value store interface that would allow the use of <a href="https://github.com/treeverse/lakeFS/blob/master/design/open/metadata_kv/index.md#databases-that-meet-these-requirements-examples">many databases</a> that meet its naive requirements.
Non-production single server installations can leverage an embedded key-value store like RocksDB, that will allow running with only a single container.</p>

                

                


            </div>
        </div>

        
        

        <div class="search-overlay"></div>
        
    </div>
</div>

<footer>
    <div class="footer-sidebar"></div>
    <div class="footer-main">
        <div class="row">
            <a href="https://lakefs.io" class="site-title lh-tight">
                <div class="site-logo"></div>
            </a>
        </div>
        <div class="row">
            <div class="left">
                <ul class="footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://docs.lakefs.io/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Docs
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/blog/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Blog
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            GitHub
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/community/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Community
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/cloud-registration/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            lakeFS Cloud
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/contact-us/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Contact
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
            <div class="right">
                <ul class="footer-social">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/youtube" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/assets/icons/youtube.svg" class="no-hover" />
                            <img src="/assets/icons/youtube-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://www.linkedin.com/company/treeverse" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/assets/icons/linkedin.svg" class="no-hover" />
                            <img src="/assets/icons/linkedin-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://github.com/treeverse/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/assets/icons/github.svg" class="no-hover" />
                            <img src="/assets/icons/github-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://twitter.com/lakeFS" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/assets/icons/twitter.svg" class="no-hover" />
                            <img src="/assets/icons/twitter-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/slack" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            <img src="/assets/icons/slack.svg" class="no-hover" />
                            <img src="/assets/icons/slack-hover.svg" class="hover" />
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row top-border">
            <div class="left"><a href="https://www.treeverse.io/">
                    <div class="other-logo"><img src="/assets/by-treeverse.png" /></div>
                </a></div>
            <div class="right">
                <ul class="bottom-footer-links">
                    
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/terms-of-use/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Terms of use
                        </a>
                    </li>
                    
                    <li class="aux-nav-list-item">
                        <a href="https://lakefs.io/privacy-policy/" class="site-button"  target="_blank"
                            rel="noopener noreferrer" >
                            Privacy Policy
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
    </div>
</footer>


</body>

</html>

